<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <!-- Load D3 library version 4 -->
    <script src="https://d3js.org/d3.v4.min.js"></script>
    <title>Interactive HeatMap with Aggregated Counts</title>
    <style>
      body { font-family: sans-serif; }
      #controls { margin-bottom: 20px; }
      select { margin: 0 10px; }
      .axis text { font-size: 12px; }
      .tooltip {
        position: absolute;
        background-color: white;
        border: solid 2px #ccc;
        border-radius: 5px;
        padding: 5px;
        pointer-events: none;
        opacity: 0;
        transition: opacity 0.2s ease-in-out;
      }
    </style>
  </head>
  <body>
    <h2>Interactive HeatMap</h2>

    <!-- Dropdowns for selecting axis dimensions -->
    <div id="controls">
      X-Axis:
      <select id="x-axis-select">
        <option value="cage2">Age</option>
        <option value="q11">Income</option>
        <option value="health">Health Conditions</option>
      </select>
      Y-Axis:
      <select id="y-axis-select">
        <option value="cage2">Age</option>
        <option value="q11">Income</option>
        <option value="health">Health Conditions</option>
      </select>
    </div>

    <!-- Div where the heatmap is drawn -->
    <div id="my_dataviz"></div>
    <div class="tooltip" id="tooltip"></div>

    <script>
      // Set dimensions and margins.
      var margin = {top: 30, right: 30, bottom: 80, left: 80},
          width = 450 - margin.left - margin.right,
          height = 450 - margin.top - margin.bottom;

      // Append SVG.
      var svg = d3.select("#my_dataviz")
        .append("svg")
        .attr("width", width + margin.left + margin.right)
        .attr("height", height + margin.top + margin.bottom)
        .append("g")
        .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

      // Tooltip setup
      var tooltip = d3.select("#tooltip");

      // Global variable to store the loaded data
      var dataGlobal;

      // Health condition fields and their labels.
      var healthFields = ["q3_01", "q3_02", "q3_03", "q3_04", "q3_05", "q3_06", "q3_07", "q3_08", "q3_09", "q3_10", "q3_11", "q3_12"];
      var healthLabels = {
        "q3_01": "Hearing problems",
        "q3_02": "Vision problems",
        "q3_03": "Mobility limitations",
        "q3_04": "Dexterity issues",
        "q3_05": "Breathing difficulties",
        "q3_06": "Mental ability issues",
        "q3_07": "Social behavior conditions",
        "q3_08": "Mental health conditions",
        "q3_09": "Other illnesses",
        "q3_10": "No impairments",
        "q3_11": "Prefer not to say",
        "q3_12": "Don't know"
      };

      // Age ordering used in the heatmap
      var ageOrder = ["16-24", "25-34", "35-44", "45-54", "55-64", "65+"];

      // Income mapping and ordering
      var incomeMapping = {
        "Up to £199 per week / Up to £10,399 per year": "£0-£10,399",
        "£200 to £299 per week / £10,400 to £15,599 per year": "£10,400-£15,599",
        "£300 to £499 per week / £15,600 to £25,999 per year": "£15,600-£25,999",
        "£500 to v699 per week / £26,000 to £36,399 per year": "£26,000-£36,399",
        "£700 to £999 per week / £36,400 to £51,999 per year": "£36,400-£51,999",
        "£1,000 and above per week / £52,000 and above per year": "£52,000+",
        "Don't know": "Don't know",
        "Prefer not to say": "Prefer not to say"
      };
      var incomeOrder = [
        "£0-£10,399", "£10,400-£15,599", "£15,600-£25,999",
        "£26,000-£36,399", "£36,400-£51,999", "£52,000+",
        "Don't know", "Prefer not to say"
      ];

      // Utility function to return the relevant categories from a row
      function getCategories(d, axis) {
        if (axis === "health") {
          return healthFields.filter(field => d[field] && d[field].toLowerCase() === "yes")
                             .map(field => healthLabels[field] || field);
        } else if (axis === "q11") {
          return [incomeMapping[d[axis]] || d[axis]];
        } else {
          return [d[axis]];
        }
      }

      // This function aggregates the data based on current axis selections
      function updateHeatmap() {
        var xAttr = document.getElementById("x-axis-select").value;
        var yAttr = document.getElementById("y-axis-select").value;

        // Aggregate data into a key-based object
        var aggregated = {};
        dataGlobal.forEach(function(d) {
          var xCats = getCategories(d, xAttr);
          var yCats = getCategories(d, yAttr);
          xCats.forEach(xCat => {
            yCats.forEach(yCat => {
              var key = xCat + "_" + yCat;
              aggregated[key] = aggregated[key] || { xCat: xCat, yCat: yCat, count: 0 };
              aggregated[key].count += 1;
            });
          });
        });

        // Force domain ordering for known axes
        var xDomain = xAttr === "cage2" ? ageOrder
                     : xAttr === "q11" ? incomeOrder
                     : xAttr === "health" ? healthFields.map(f => healthLabels[f])
                     : Array.from(new Set(dataGlobal.flatMap(d => getCategories(d, xAttr))));

        var yDomain = yAttr === "cage2" ? ageOrder
                     : yAttr === "q11" ? incomeOrder
                     : yAttr === "health" ? healthFields.map(f => healthLabels[f])
                     : Array.from(new Set(dataGlobal.flatMap(d => getCategories(d, yAttr))));

        // Build a complete grid (cross-product of x and y)
        var fullData = [];
        xDomain.forEach(xVal => {
          yDomain.forEach(yVal => {
            var key = xVal + "_" + yVal;
            fullData.push(aggregated[key] || { xCat: xVal, yCat: yVal, count: 0 });
          });
        });

        // Clear SVG before drawing
        svg.selectAll("*").remove();

        // Create scales
        var xScale = d3.scaleBand().range([0, width]).domain(xDomain).padding(0.05);
        var yScale = d3.scaleBand().range([height, 0]).domain(yDomain).padding(0.05);

        // Draw x-axis
        svg.append("g")
          .attr("transform", "translate(0," + height + ")")
          .call(d3.axisBottom(xScale).tickSize(0))
          .selectAll("text")
          .style("text-anchor", "end")
          .attr("dx", "-.8em")
          .attr("dy", ".15em")
          .attr("transform", "rotate(-45)");

        // Draw y-axis
        svg.append("g").call(d3.axisLeft(yScale).tickSize(0));

        // Define color scale
        var maxCount = d3.max(fullData, d => d.count);
        var myColor = d3.scaleLinear()
            .range(["#CAF0F8", "#023E8A"])
            .domain([1, maxCount])

        // Create heatmap cells with hover effects and tooltip
        svg.selectAll()
          .data(fullData, d => d.xCat + ":" + d.yCat)
          .enter()
          .append("rect")
          .attr("x", d => xScale(d.xCat))
          .attr("y", d => yScale(d.yCat))
          .attr("width", xScale.bandwidth())
          .attr("height", yScale.bandwidth())
          .attr("rx", 4)
          .attr("ry", 4)
          .style("fill", d => myColor(d.count))
          .style("stroke", "none")
          .style("opacity", 0.8)
          .on("mouseover", function(d) {
            tooltip.style("opacity", 1);
            d3.select(this).style("stroke", "black").style("opacity", 1);
          })
          .on("mousemove", function(d) {
            tooltip
              .html(`<strong>${d.xCat} &times; ${d.yCat}</strong><br/>Count: ${d.count}`)
              .style("left", (d3.event.pageX + 10) + "px")
              .style("top", (d3.event.pageY - 28) + "px");
          })
          .on("mouseleave", function() {
            tooltip.style("opacity", 0);
            d3.select(this).style("stroke", "none").style("opacity", 0.8);
          });
      }

      // Load data from CSV and initialize
      let datapath = "data/digital-exclusion-data.csv";  // Adjust if needed
      d3.csv(datapath, function(data) {
        dataGlobal = data;
        updateHeatmap();
      });

      // Attach update handler to dropdowns
      document.getElementById("x-axis-select").addEventListener("change", updateHeatmap);
      document.getElementById("y-axis-select").addEventListener("change", updateHeatmap);
    </script>
  </body>
</html>
